# -----------------------------------------
# üì¶ .github/workflows/deploy.yml
# ‚öôÔ∏è Script: Pipeline de despliegue de pagina web en php y composer
# üôç Autor: Getsemani √Åvila
# üìÖ Fecha: 2025-05-13
# -----------------------------------------

  name: Despliegue por etapas

  on:
    push:
      branches: [ "main" ]
  
  jobs:
    deploy:
      name: üöö Stage 1 - Despliegue de archivos
      runs-on: self-hosted
      outputs:
        repo_name: ${{ steps.vars.outputs.repo_name }}
        branch_name: ${{ steps.vars.outputs.branch_name }}
  
      steps:
        - name: üß© Checkout del repositorio
          uses: actions/checkout@v3
  
        - name: üõ†Ô∏è Obtener nombre del repo y branch
          id: vars
          run: |
            echo "repo_name=$(basename $GITHUB_REPOSITORY)" >> $GITHUB_OUTPUT
            echo "branch_name=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
  
        - name: üìÅ Desplegar a carpeta din√°mica
          run: |
            TARGET_DIR="/var/www/${{ steps.vars.outputs.repo_name }}_${{ steps.vars.outputs.branch_name }}"
            echo "Creando carpeta destino: $TARGET_DIR"
            sudo mkdir -p "$TARGET_DIR"
            sudo rsync -av --delete ./ "$TARGET_DIR/"
  
    composer:
      name: üì¶ Stage 2 - Instalar dependencias Composer
      runs-on: self-hosted
      needs: deploy
      steps:
        - name: Instalar Composer si aplica
          run: |
            TARGET_DIR="/var/www/${{ needs.deploy.outputs.repo_name }}_${{ needs.deploy.outputs.branch_name }}"
            if [ -f "$TARGET_DIR/composer.json" ]; then
              echo "üì¶ Ejecutando Composer en $TARGET_DIR"
              cd "$TARGET_DIR"
              sudo -u github-action composer install --no-interaction --prefer-dist --no-dev
            else
              echo "‚ö†Ô∏è No se encontr√≥ composer.json"
            fi
  
    apache-config:
      name: üîß Stage 3 - Configurar Apache VirtualHost
      runs-on: self-hosted
      needs: composer
      steps:
        - name: Ejecutar script de configuraci√≥n de Apache
          run: |
            sudo bash /opt/scripts/configurar-apache.sh \
              "${{ needs.deploy.outputs.repo_name }}" \
              "${{ needs.deploy.outputs.branch_name }}"
  